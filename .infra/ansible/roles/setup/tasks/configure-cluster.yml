- name: Configure kubernetes cluster
  delegate_to: localhost
  run_once: true
  no_log: true
  environment: 
    AWS_ACCESS_KEY_ID: "{{ setup.AWS_ACCESS_KEY_ID }}"
    AWS_SECRET_ACCESS_KEY: "{{ setup.AWS_SECRET_ACCESS_KEY }}"
    TF_VAR_docker_server: "{{ setup.DOCKER_REGISTRY }}"
    TF_VAR_docker_username: "{{ setup.DOCKER_USERNAME }}"
    TF_VAR_docker_password: "{{ setup.DOCKER_PASSWORD }}"
    TF_VAR_loadbalancer_ip: "{{ loadbalancer_ip }}"
    TF_VAR_monitoring_host: "{{ monitoring_host }}"
    TF_VAR_monitoring_admin_password: "{{ setup.MONITORING_ADMIN_PASSWORD }}"
    TF_VAR_slack_oauth: "{{ setup.SLACK_OAUTH}}"
    TF_VAR_slack_channel: "{{ slack_channel }}"
    TF_VAR_github_org: "{{ github_org }}"
    TF_VAR_dex_domain: "{{ dex_domain }}"
    TF_VAR_admin_users: "{{ habilitations | map(attribute='username') | select('ne', '') | list | to_json }}"
    TF_VAR_github_client_id: "{{ setup.GITHUB_CLIENT_ID }}"
    TF_VAR_github_client_secret: "{{ setup.GITHUB_CLIENT_SECRET }}"
  community.general.terraform:
    #init_reconfigure: true 
    project_path: '{{ playbook_dir }}/{{ project_dir }}'
    state: "{{ state }}"
    force_init: true
    backend_config:
      region: "gra"
      bucket: "cqlp-terraform"
      key: "terraform.tfstate"